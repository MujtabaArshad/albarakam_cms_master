cmsdefine(["Underscore","CMS/Eventhub","jQuery"],function(n,t,i){var u={parentSelector:".js-filter-parent",itemSelector:".js-filter-item",filterEmptyMessageSelector:".js-filter-empty",selectedItemClass:"highlighted",onItemActivated:function(n){n&&n.$link.click()},onBeforeItemChange:function(){},onChange:function(){},specialKeyActions:{40:function(n){this.selectNext(n)},38:function(n){this.selectPrevious(n)},9:function(n){this.selectNext(n)},13:function(n){if(this.selectedItem&&!this.isEditable)this.options.onItemActivated(n,this.selectedItem)}}},r=function(i,r,f){var e=this,o;this.active=!1;this.options={};this.isEditable=!1;n.extend(this.options,u,f);this.$textInput=r;this.$emptyMessage=i.find(this.options.filterEmptyMessageSelector);this.$parents=i.find(this.options.parentSelector);this.onChangeCallbacks=[];this.onChangeCallbacks.push(this.options.onChange);this.onChangeCallbacks.push(function(){e.selectedItem=undefined;e.visibleItems.length>0&&e.selectFirst()});this.$emptyMessage.hide();this.textInputValue="";this.initItems(i);this.visibleItems=[];this.selectedItem=undefined;this.onKeyDownValue=undefined;this.keyUpCalled=!1;this.$textInput.on("keydown",function(n){e.keyUpCalled&&(e.keyUpCalled=!1,e.onKeyDownValue=this.value);e.onInputKeyDown(n)});this.$textInput.on("keyup",function(n){e.onInputKeyUp(n,this.value)});o=function(n){e.isEditable=n};t.subscribe("cms.applicationdashboard.DashboardEditableModeChanged",o);t.subscribe("DashboardClicked",function(){o(!1)})};return r.prototype.resetFilter=function(){var n=this.options.onReset;this.$textInput.val("");this.textInputValue="";this.selectedItem=undefined;n&&n();this.update("");this.active=!1;this.unselectAllItems()},r.prototype.onInputKeyDown=function(t){this.active&&n.isFunction(this.options.specialKeyActions[t.which])&&(t.preventDefault(),this.options.specialKeyActions[t.which].call(this,t))},r.prototype.onInputKeyUp=function(n,t){var i=this.options.onStartCb;this.keyUpCalled=!0;this.textInputValue=t.toLowerCase();this.textInputValue&&(this.active||(i&&i(),this.active=!0),this.update(this.textInputValue));!this.textInputValue&&this.onKeyDownValue&&this.resetFilter()},r.prototype.initItems=function(t){var r=this;this.items=[];this.$parents||(this.$parents=t);n.each(this.$parents,function(t){var u=i(t),e=u.find(r.options.itemSelector),f=[];n.each(e,function(n){var t=i(n);f.push({text:t.text().trim().toLowerCase(),$el:t,$link:t.find("a"),visible:!0})});r.items.push({$parent:u,items:f,visible:!0})})},r.prototype.selectFirst=function(){this.selectedItem=this.visibleItems[0];this.selectItem(this.selectedItem.$el)},r.prototype.selectNext=function(n){if(n.keyCode===9&&n.shiftKey){this.selectPrevious(n);return}var r=this.visibleItems.length-1,t,i=this.visibleItems.indexOf(this.selectedItem);t=i<r?this.visibleItems[i+1]:this.visibleItems[0];t&&(this.selectItem(t.$el),this.selectedItem=t)},r.prototype.selectPrevious=function(){var n,t=this.visibleItems.indexOf(this.selectedItem);n=t>0?this.visibleItems[t-1]:this.visibleItems[this.visibleItems.length-1];n&&(this.selectItem(n.$el),this.selectedItem=n)},r.prototype.update=function(n){var t=!0,i=this;this.active&&this.currentQuery!==n&&(this.visibleItems=[],this.eachParent(function(r,u){var f=i.updateParent(r,u.items,n);f||(t=!1)}),this.currentQuery=n,this.$emptyMessage.toggle(t),this.filterUpdated())},r.prototype.updateParent=function(t,i,r){var s=this.options.onBeforeItemChange,f=[],e=[],u=null,o=!0;return n.each(i,function(n){var t,h,i;s(n.$el);t=n.text.indexOf(r);t<0&&(h=r.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),i=new RegExp(h.split(" ").join(".* ")).exec(n.text),t=i===null?-1:i.index);t>=0?(n.$el.show(),o=!1,u===null&&(u=n.$el.parent()),t===0?f.push(n):e.push(n)):n.$el.hide()}),this.appendItems(f,u),this.appendItems(e,u),this.visibleItems=this.visibleItems.concat(f.concat(e)),this.parentUpdated(o,t),o},r.prototype.selectItem=function(t){if(this.unselectAllItems(),t.addClass(this.options.selectedItemClass),n.isFunction(this.options.onItemSelected))this.options.onItemSelected(t)},r.prototype.unselectAllItems=function(){n(this.visibleItems).each(function(n){n.$el.removeClass(this.options.selectedItemClass)},this)},r.prototype.eachParent=function(n){var t=0,i=this.items,r=i.length;for(t;t<r;t++)n.call(this,i[t].$parent,i[t])},r.prototype.appendItems=function(t,i){n.each(t,function(n){i.append(n.$el)})},r.prototype.parentUpdated=function(n,t){n?this.options.onParentEmptyCb&&this.options.onParentEmptyCb(t):this.options.onParentNonemptyCb&&this.options.onParentNonemptyCb(t)},r.prototype.filterUpdated=function(){n.each(this.onChangeCallbacks,function(n){n()})},r})