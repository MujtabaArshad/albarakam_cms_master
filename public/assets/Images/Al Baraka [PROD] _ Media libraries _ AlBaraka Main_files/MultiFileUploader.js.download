cmsdefine(["CMS/EventHub","AdminControls/MultipartUploader"],function(n,t){var i=new t;return function(t){var w,b;if(!window.File||!window.FileReader||!window.FileList||!window.Blob){document.getElementById(t.overlayClientID).style.display="none";return}var u=document.getElementById(t.uploaderClientID),d=t.maxNumberToUpload,g=t.maximumTotalUpload,ut=t.maximumTotalUploadString,nt=t.maximumUploadSize,ft=t.maximumUploadSizeString,l=t.uploadChunkSize,tt=t.onUploadBegin,f=t.onUploadCompleted,it=t.onUploadProgressChanged,e=t.containerID,o=0,h=0,a=0,v=0,y=0,r,c=!1,p=!1,et=t.allowedExtensions.split("|")[0];l===0&&(l=5242880);var ot=function(){for(var t=0,n=0,i=r.length;n<i;n++)t+=r[n].size;return t},st=function(){for(var i,n=0,t=0,u=r.length;t<u;t++)i=r[t].size,n<i&&(n=i);return n},ht=function(){var o,f,n,e,s,i,u;if(t.allowedExtensions)for(o=t.allowedExtensions.split("|"),f=o[0].split(";"),i=0;i<r.length;i++){for(e=!1,n=r[i].name.toLowerCase(),u=0;u<f.length;u++)s=f[u].toLowerCase(),n.match(s+"$")&&(e=!0);if(!e)return n.substr(n.lastIndexOf(".")+1)}return""},rt=function(){c=!0};n.subscribe("UploadCanceled",function(n){n===e&&rt()});w=function(n){var i=new XMLHttpRequest;i.open("post",t.uploadPage+"?InstanceGuid="+t.instanceGuid+"&filename="+encodeURIComponent(n.name)+"&FilesCount="+o+"&ResizeArgs="+t.resizeArgs+"&GetBytes=true&"+t.modeParameters+"&"+t.aditionalParameters+"&CurrentFileIndex="+(h+1)+"&FileSize="+n.size+"&AllowedExtensions="+t.allowedExtensions,!0);i.onloadend=function(){var r=i.responseText,t=r.split("|");t.length==2?(alert(t[1]),f&&s(f,window,e)):b(n)};i.send()};b=function(n,u){var nt;if(p)f&&s(f,window,e);else{u=u||0;var d=0,g=u+l,k=new XMLHttpRequest,tt=g>=n.size;k.open("post",t.uploadPage+"?InstanceGuid="+t.instanceGuid+"&filename="+encodeURIComponent(n.name)+"&FilesCount="+o+"&ResizeArgs="+t.resizeArgs+"&complete="+tt+"&StartByte="+u+"&"+t.modeParameters+"&"+t.aditionalParameters+"&CurrentFileIndex="+(h+1)+"&FileSize="+n.size+"&AllowedExtensions="+t.allowedExtensions+(c?"&canceled=1":""),!0);k.upload.onprogress=function(n){n.lengthComputable&&it&&s(it,window,e,a,v+n.loaded,0)};k.onloadend=function(){var t=k.responseText,u;if(i.isFileUploadedInOneChunk(d,n.size)||i.handleResponseAfterUploadingOnePart(t),t&&t.lastIndexOf("0|",0)===0){u=t.split("|");alert(u[1]);rt();f&&s(f,window,e);return}v+=d;g<n.size?b(n,g):(y--,y>0?(h++,w(r[h])):(t&&new Function("files",t)(r),f&&s(f,window,e),ct()))};c&&(p=!0);nt=n.slice(u,g);d=nt.size;i.isFileUploadedInOneChunk(d,n.size)?(k.setRequestHeader("Content-Type","application/octet-stream"),k.send(nt)):i.sendDataViaMultipartUpload(k,nt,tt)}};u.onchange=function(){if(o=this.files.length,o){v=0;r=this.files;a=ot();y=o;h=0;c=!1;p=!1;var n=ht();if(n){alert(k(window.MFUResources["multifileuploader.extensionnotallowed"],n,et.replace(/;/g,", ")));return}if(d&&o>d){alert(window.MFUResources["multifileuploader.maxnumbertoupload"]);return}if(nt&&st()>nt){alert(k(window.MFUResources["multifileuploader.maxuploadsize"],ft));return}if(g&&a>g){alert(k(window.MFUResources["multifileuploader.maxuploadamount"],ut));return}tt&&s(tt,window,e);w(r[0])}};var s=function(n,t){for(var u=[].slice.call(arguments).splice(2),i=n.split("."),f=i.pop(),r=0;r<i.length;r++)t=t[i[r]];return t[f].apply(this,u)},k=function(){for(var i,t=arguments[0],n=1;n<arguments.length;n++)i=new RegExp("\\{"+(n-1)+"\\}","gm"),t=t.replace(i,arguments[n]);return t.replace("\\n","\n")},ct=function(){for(var i,r,n=document.createElement("input"),t=0;t<u.attributes.length;t++)i=u.attributes[t].name,r=u.attributes[t].value,i!="value"&&n.setAttribute(i,r);n.onchange=u.onchange;u.parentNode.replaceChild(n,u);u=n}}})